---
title: "Electoral districts and parlamentary groups"
author: "Joni Oksanen"
date: "02/07/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggsflabel)
```

```{r data}
raw_data <- readRDS("politics_and_place/districts.rds")
```


```{r plot_data_aggregate_fun}

preprocess_district_data <- function(df, time_period, cut, district){
  
  
  
  df %>%
    filter(period == time_period) %>%
    filter(speaker_electoral_district == district) %>%
    mutate(time = ifelse(year < cut, 
                         paste(min(year), "-", (cut-1)), 
                         paste(cut, "-", year[which.max(year)]))) %>%
    group_by(electoral_district, speaker_electoral_district, time) %>%
    summarize(speaker_district_count = sum(speaker_district_count, na.rm = TRUE),
                 speaker_district_total = sum(speaker_district_total, na.rm = TRUE), .groups = "drop") %>%
    mutate(speaker_district_prop  = speaker_district_count / speaker_district_total)
  
}
```


```{r plot_fun}
plot_map <- function(df,fill = "speaker_district_count", wrap_col = "time", title = NULL, subtitle = NULL){
  
  plot <- ggplot(df,
                 aes_string(fill = fill,
                            geometry = "geom")) +
    geom_sf(colour = alpha("white", 1/3)) +
    labs(title = title, subtitle = subtitle) +
    # geom_sf_label_repel(
    #   aes(label = electoral_district, geometry = geom),
    #   fill = "grey",
    #   force = 100, nudge_x = -2, seed = 10) +
    theme_minimal() +
theme(legend.position= "right",
        axis.text = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank()
        ) +
  facet_wrap(as.formula(paste("~", wrap_col)))

return(plot)
}
```


## Mentions of municipalities by parlamentary group aggregated by electoral district 

```{r max_data}
raw_data %>% 
  preprocess_district_data(time_period = "1986-1995", cut = 1990, district = "Hämeen vaalipiiri") %>%
  plot_map(fill = "speaker_district_prop", title = "Hämeen vaalipiiri", subtitle = paste("First year of the economic crisis:", 1990)) +
  viridis::scale_fill_viridis(name = "Mentions\n(normalized)")

```

```



## Most mentions of electoral districts by parlamentary group by year

